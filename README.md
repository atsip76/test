# Тест 

## Задача:
- написать скрипт на bash или python выкачивания из репозитория debian "bullseye" и автоматической сборки из исходных текстов нескольких пакетов (bash gawk sed) и их build зависимостей в чистом debootstrap из репозитория debian bullseye
- результат нужно оформить в виде deb пакета, и дополнить комментариями
- рассмотреть вопрос (можно пока в теории) упорядочивания зависимостей, разрыва циклических
зависимостей и формирования очередности пересборки

## Решение:
- Создаем каталог для сборки пакета **astra-test.deb** след. структуры и файлами:
**DEBIAN** 
     - **control** главный файл управления сборкой пакета, зависимостей, содержит все метаданные пакета
     - **postinst** управляющий файл выполняемый после установки зависимостей, создания директорий и файлов. может содержать сценарии на bash perl python. в этой сборке служит для запуска скрипта компиляции пакетов в фоне, для предотвращения конфликта процессов dpkg

  **opt** - каталог в целевой системе для установки и запуска скрипта сборки пакетов add-pkg.sh
  - **add-pkg.sh** основной скрипт компиляции пакетов, копируется и запускается в директории opt при установки пакета astra-test.deb (содержит подробные комментарии выполняемых действий)
- устанавливаем необходимые инструменты: apt install dpkg debconf debhelper lintian 
- собираем пакет - **fakeroot dpkg-deb --build astra-test** (fakeroot утилита меняющая владельца во время архивирования на root, делает владельцем структуры каталогов пакета при сборке, если собираем пакет не под root)
- прогоняем предварительный тест утилитой lintian, позволяющая проверить пакет и выявить типичные ошибки в его структуре: ```$ lintian astra-test.deb```
- cозданный пакет необходимо переименовать, чтобы он соответствовал порядку именования *.deb пакетов: <имя пакета>_<версия>_<архитектура>.deb
  mv astra-test.deb astra-testh_0.1_all.deb
- переходим к тестам на виртуальной машине с chroot в debootstrap


### Выполняем тесты:
* Создаем виртуальную машину, используя debootstrap создаем в выделенной директории базовую систему debian. монтируем в раздел 
* Устанавливаем чистую систему в директорию /home/work/debootstrap: 
  export MY_CHROOT=/home/work/test
  ```sudo debootstrap stable  $MY_CHROOT http://deb.debian.org/debian/```
* Монтируем ВФС хост ОС:
```
mount -t proc proc $MY_CHROOT/proc 
mount --rbind /sys $MY_CHROOT/sys
mount --make-rslave $MY_CHROOT/sys  
mount --rbind /dev $MY_CHROOT/dev
mount --make-rslave $MY_CHROOT/dev
```
выполняем ```chroot $MY_CHROOT/ /usr/bin/env -i HOME=/root TERM="$TERM" /bin/bash --login```
* настраиваем сеть, задаем пароль рута, стартуем sshd
* заливаем по scp наш созданный пакет astra-test.deb
* выполняем установку пакета dpkg -i astra-test.deb
* контролируем процесс, фиксим баги при необходимости

### Упорадочивание зависимостей пакета при сборке
Для того, чтобы один пакет зависел от другого, необходимо указать отношение в **debian/control** файле например в поле Depends: \${shlibs:Depends}, ${misc:Depends} кроме поля Depends за отношения между пакетами отвечают Recommends, Suggests, Pre-Depends, Breaks, Conflicts, Provides и Replaces:

    Depends
    Пакет не будет установлен, пока не установлены пакеты, от которых он зависит. Используйте этот тип зависимости, если ваша программа гарантировано не будет работать (или вызовет какие-нибудь серьезные проблемы) при отсутствии какого-то пакета.
    Recommends
    Используйте это поле для пакетов, которые не обязательны, но обычно используются с вашей программой. При установке программы все интерфейсы управления пакетами предложат пользователю установить и рекомендуемые пакеты. Утилиты aptitude и apt-get по умолчанию (которое можно изменить) автоматически устанавливают рекомендуемые пакеты вместе с пакетом. Утилита dpkg игнорирует это поле.
    Suggests
    Используйте это поле для пакетов, которые отлично дополнят вашу программу, но не требуются для её работы. При установке программы интерфейсы управления пакетами, обычно, не предлагают пользователю установить такие пакеты. В aptitude можно включить автоматическую установку этих предлагаемых (suggested) пакетов (по умолчанию не выполняется). Программы dpkg и apt-get игнорируют это поле.
    Pre-Depends
    В этом поле указываются более важные зависимости, чем в Depends. Пакет не будет установлен, если какие-либо пакеты из числа таких зависимостей не установлены, либо не правильно настроены. Используйте это поле очень осторожно и только после обсуждения в рассылке debian-devel@lists.debian.org. Ещё лучше — не используйте его вообще :-)
    Conflicts
    Пакет не будет установлен, пока все перечисленные в этом поле пакеты не будут удалены. Используйте это поле только, если ваша программа не будет запускаться, либо возникнут серьёзные проблемы при наличии этих пакетов.
    Breaks
    Если пакет будет установлен, то работоспособность всех перечисленных пакетов будет нарушена. Чаще всего, в поле Breaks указываются пакеты с уточнением версии типа «старее чем». Утилиты управления пакетами, обычно, предлагают обновить перечисленные пакеты до более новых версий.
    Provides
    For some types of packages where there are multiple alternatives, virtual names have been defined. You can get the full list in the virtual-package-names-list.txt.gz file. Use this if your program provides a function of an existing virtual package.
    Replaces
    Используйте данное поле, если ваш пакет заменяет файлы из другого пакета или же полностью заменяет другой пакет (в этом случае вы также должны использовать поле Conflicts). В этом случае файлы из указанного пакета будут перезаписаны файлами из вашего.

Формат всех этих полей одинаков. Он представляет собой список имён пакетов, разделённых запятыми. Здесь также могут быть указаны имена альтернативных пакетов, разделённые вертикальной чертой |.
Для каждого пакета в списке можно указать версии, которых касается данная зависимость. Версии указываются в круглых скобках после имени пакета и должны состоять из символа сравнения, за которым следует номер версии. Допустимыми символами сравнения являются: <<, <=, =, >= и >> для «строго раньше», «раньше или равно», «в точности равно», «равно или позже» и «строго позже», соответственно. Например:
Depends: foo (>= 1.2), libbar1 (= 1.3.4)
Conflicts: baz
Recommends: libbaz4 (>> 4.0.7)
Suggests: quux
Replaces: quux (<< 5), quux-foo (<= 7.6)

### Разрыв циклических зависимостей
 В свое время много намучился с такими задачками в gentoo :)
 Циклическа зависимость один из примеров: 
пакет-а зависит от пакета-b для запуска, а пакет-b зависит от пакета-а для компиляции, соответственно проблема с установкой пакета-а. Два (или более) пакетов для установки зависят друг от друга и поэтому не могут быть установлены. Часто бывает после обновлений одного из пакетов и повышении версии.
Решал переустановкой (установкой) зависимого пакета более низкой версии (или выше, в зависимости от конкретной ситуации). Можно в debian/control изменить версию и порядок зависимости пакетов или убрать пакет-b для запуска, по рекомендациям из оф. документации приведенных выше.
Иногда приходилось временно удалять конфликтующий пакет из системы, собирать нужный пакет и после заново устанавливать удаленный пакет.


### Формирование очередности пересборки
Настройка в debian/control
Pre-Depends,более требовательный параметр чем Depends
Список пакетов, которые требуются в процессе установки этого пакета.
Эти зависимости могут потребоваться для скриптов установки пакета: например, пакет flash-installer требует wget Можно использовать ограничения на версию (см. Depends).
«Предварительные зависимости», перечисленные в поле «Pre-Depends» заголовков пакетов, дополняют обычные зависимости; их синтаксис аналогичен. Обычная зависимость показывает, что пакет должен быть распакован и настроен до настройки зависимого пакета. Предварительная зависимость оговаривает, что пакет должен быть распакован и настроен до запуска предустановочного сценария пакета, для которого указана предварительная зависимость, то есть до его установки.
Предварительная зависимость очень требовательна к apt, поскольку добавляет строгие ограничения на порядок установки пакетов. Поэтому использование предварительных зависимостей без крайней необходимости не поощряется. Более того, перед добавлением предварительной зависимости рекомендовано проконсультироваться с разработчиками.# test
